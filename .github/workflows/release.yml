name: Android CI & Release

on:
  push:
    tags:
      - 'v*' 
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Decode the Base64 keystore and place it in the app/build directory.
      # This matches the 'layout.buildDirectory' path defined in build.gradle.kts.
      - name: Decode Keystore
        run: |
          mkdir -p app/build
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/build/release.jks

      # Build APKs. Gradle will automatically sign the Release APK using the environment variables.
      - name: Build with Gradle
        run: ./gradlew assembleRelease assembleDebug
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      # Consolidate APKs into a single directory and rename them for clarity.
      - name: Prepare APKs for Release
        run: |
          mkdir -p release_artifacts
          cp app/build/outputs/apk/debug/app-debug.apk release_artifacts/CaptchAutofill-${{ github.ref_name }}-Debug.apk
          cp app/build/outputs/apk/release/app-release.apk release_artifacts/CaptchAutofill-${{ github.ref_name }}-Release.apk

      # Upload the artifacts for internal use/storage.
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CaptchAutofill-APKs
          path: release_artifacts/*

      # Create a new GitHub Release with the versioned APKs.
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_artifacts/*
          name: Release ${{ github.ref_name }}
          body: |
            ### ðŸš€ Build Successful (Android 16 API 36)
            
            Automated release generated via GitHub Actions for **Pengcheng Zhang**.
            
            **Release Notes:**
            - **Target**: Android 16 (Baklava)
            - **Features**: Optimized boot synchronization logic.
            - **Signature**: Verified and signed via native Gradle workflow.
            
            **Artifacts:**
            - `Release.apk`: Obfuscated and signed (recommended for use).
            - `Debug.apk`: Unobfuscated with full logging for Pixel 10 Pro debugging.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
